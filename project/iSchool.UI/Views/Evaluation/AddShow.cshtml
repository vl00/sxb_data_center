@using iSchool.Organization.Appliaction.ViewModels
@using iSchool.Infrastructure;
@using iSchool.Organization.Domain.Enum;
@model AddEvaluationShowDto
@{
    ViewData["Title"] = "评测内容管理";
}

@section css
{
    <link href="@(ViewBag.StaticFile)/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">
    <link href="@(ViewBag.StaticFile)/cropper/4.0.0-beta/cropper.min.css" rel="stylesheet">

    <link href="~/lib/cropper/main.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet">

    <link href="https://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">

    <link href="~/css/jsselect/select.css" rel="stylesheet" />

    <style type="text/css">
        /*tags样式*/
        .label-info {
            display: inline-block;
            padding: 2px 4px;
            font-size: 11.844px;
            font-weight: bold;
            line-height: 14px;
            text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
            white-space: nowrap;
            vertical-align: baseline;
            background-color: #3a87ad;
            margin-right: 2px;
            color: white;
        }

        .bootstrap-tagsinput {
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
            /*display: inline-block;*/
            /*padding: 4px 6px;*/
            padding: .375rem .75rem;
            color: #555;
            vertical-align: middle;
            border-radius: 4px;
            max-width: 100%;
            line-height: 22px;
            cursor: text;
            width: 100%;
        }

        .str {
            width: 150px;
            height: 200px;
            border: solid 1px #e3e3e3;
            padding: 5px;
            margin-top: 10px
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            -moz-border-radius: 40px; /* 老的 Firefox */
        }

        .typeahead {
            z-index: 1051;
        }

        .a-href {
            cursor: pointer;
        }

        .c_contain {
        }

        .c_value {
        }

        .select2-dropdown, .select2 {
            width: 200px !important;
        }

        .counterpart-content select, .ach-panel-content select {
            width: 200px !important;
        }

        .deletebutten {
            position: absolute;
            display: block;
            width: 5px;
            height: -6px;
            top: 0px;
            right: 88px;
        }

        .side-bar {
            position: fixed;
            bottom: 100px;
            right: 25px;
            font-size: 0;
            line-height: 0;
            z-index: 100;
        }

            .side-bar a {
                width: 66px;
                height: 66px;
                display: inline-block;
                margin-bottom: 2px;
            }


            .side-bar .icon-right {
                background-position: 0 -62px;
            }

        #auditcard {
            width: 500px;
        }

        @if (!Context.HasCtrlActQyx("school", "ExtFieldsSync", ".sync"))
        {
            <text >
        .sync {
            display: none;
        }

            </text>
        }

        .margin-top {
            margin-top: 2%;
        }
        .margin-left {
            margin-left: 5%;
        }

        .font-size {
            font-size:20px;
        }

        .img-margin-left {
            margin-left: 3%;
        }
        .downloadpic{
            font-size:1px;
        }
        .Comments {
            width: 100%;
        }

    </style>
}

<div class="card">
    <div class="card-header">
        <div class="form-inline">
            <div class="text-left col-md-6 ">新增评测</div>
            <div class="text-right col-md-6">
                <a href="@Url.Action("Index", new { queryJson = ViewBag.queryJson,page=ViewBag.page })" data-id="" class="text-info">返回列表</a>
            </div>
        </div>

    </div>
    <div class="card-body">

        @*标题*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">标题：</label>
                <input type="text" name="Title" id="Title" class="form-control" value="" style="width:50%;" />
            </div>
        </div>

        @*专题*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">专题：</label>
                <div id="div_Special" class="selectPickerWrapper">
                    <select id="div_Special_select" class="hidden">
                        @if (Model.ListSpecials?.Any() == true)
                        {
                            foreach (var item in Model.ListSpecials)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>

        @*机构、课程*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">机构：</label>
                <div id="div_Org" class="selectPickerWrapper" multiple="multiple">
                    <select id="div_Org_select" class="hidden">
                        @if (Model.ListOrgs?.Any() == true)
                        {
                            foreach (var item in Model.ListOrgs)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        }
                    </select>
                </div>
                <label class="control-label mb-1">课程：</label>
                <div id="div_Course" class="selectPickerWrapper" multiple="multiple">
                    <select id="div_Course_select" class="hidden">
                        @if (Model.ListCourses?.Any() == true)
                        {
                            foreach (var item in Model.ListCourses)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        }
                    </select>
                </div>
                <label class="control-label mb-1" style="color:red; font-size:10px;">注：机构单选时，机构-课程才联动且课程可选；机构多选则课程不可选</label>
                @*<input type="text" name="CourseName" id="CourseName" class="form-control" placeholder="请输入自定义课程名称" value="" style="" />
        <input type="checkbox" id="CustomCourse" name="CustomCourse" checked="checked"><span class="CustomCourse">自定义课程</span>
        <a href="javascript:void(0)" class="margin-left clear-courseInfo" style="border-bottom: 1px solid #00a0ff; color: #00a0ff;">清除课程信息</a>*@
            </div>
        </div>

        @*课程信息：已有课程(Model.Courseid != null)，则以下四项都是只读；自定义课程，则可选*@
        @*<div class="form-group">
                <div style="border: 1px solid #ccc;">
                    <label class="control-label mb-1" style="margin-top: 20px; margin-left: 35px; ">课程信息：</label>
                    <div class="form-inline margin-top" style="margin-left: -2.4%; margin-bottom: 3%;">
                上课时长--单选或文本框@((Model.Duration==null || Model.Duration<=0 )?"未收录":Model.Duration+" 分钟")
                <label class="control-label mb-1 margin-left">上课时长：</label>
            <input type="text" id="Duration" name="Duration" hidden="hidden" readonly="readonly" style="width:150px;" value="" class="form-control" />
            <div id="div_Duration" class="selectPickerWrapper">
                <select id="div_Duration_select" class="hidden">
                    @if (Model.ListDurations?.Any() == true)
                    {
                        foreach (var item in Model.ListDurations)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    }
                </select>
            </div>
                上课方式--复选或文本框
                <label class="control-label mb-1" style="margin-left:1%;">上课方式：</label>
            <input type="text" id="Mode" name="Mode" hidden="hidden" readonly="readonly" style="width:260px;" value="" class="form-control" />
            <div id="div_Mode" class="selectPickerWrapper" multiple="multiple">
                <select id="div_Mode_select" class="hidden">
                    @if (Model.ListModes?.Any() == true)
                    {
                        foreach (var item in Model.ListModes)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    }
                </select>
            </div>
                科目分类--单选
                <label class="control-label mb-1" style="margin-left:1%;">科目分类：</label>
            <input type="text" id="Subject" name="Subject" hidden="hidden" readonly="readonly" style="width:150px;" value="" class="form-control" />
            <div id="div_Subject" class="selectPickerWrapper">
                <select id="div_Subject_select" class="hidden">
                    @if (Model.ListSubjects?.Any() == true)
                    {
                        foreach (var item in Model.ListSubjects)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    }
                </select>
            </div>
                年龄段--已有课程：只读最小最大年龄文本框；自定义课程年龄段单选
                <label class="control-label mb-1" style="margin-left:1%;">年龄段：</label>
                        <input type="text" hidden="hidden" name="Age" id="Age" readonly="readonly" style="width:150px;" value="" class="form-control" />
                        <div id="div_Age" class="selectPickerWrapper">
                            <select id="div_Age_select" class="hidden">
                                @if (Model.ListAges?.Any() == true)
                                {
                                    foreach (var item in Model.ListAges)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                        </div>

                    </div>
                </div>
            </div>*@
        @*图片*@
        <div class="form-group">
            <label class="control-label mb-1">图片：</label>
            <div id="img-list">
                <div class="row img-margin-left">
                    @*上传按钮*@
                    <div class="col-md-2">
                        <input type="file" id="@Model.Id" hidden="hidden" class="c_ignore updateFile" name="files" multiple accept="jpg,png" title="只允许上传Mp4格式的视频!视频大小不能超过40M" />
                        <input type="button" id="uploadlogo" style="width: 100px; height: 100px; font-size: 50px;" class="uploadvideo-btn btn  btn-info btn-block c_ignore updateBtn" data-video="@Model.Id" data-input="InterviewVideos" value="+" />
                    </div>
                </div>
            </div>
            <input type="text" id="hidUrlJson" hidden="hidden" value="[]" />
            <input type="text" id="hidThunUrlJson" hidden="hidden" value="[]" />
        </div>

        @*正文 style="width:100%;height:200px;"*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1" style="">正文：</label>
                <textarea id="Content" name="Content" rows="10" cols="150"></textarea>
            </div>

            @*<div class="border uecontent" id="content" name="content" style="min-height:50px">
                    <script id="editor1" type="text/plain" style="width:100%;height:200px;">
                    </script>
                </div>*@
        </div>

        <hr />
        @*评论*@
        <div class="form-group">
            <label class="control-label mb-1">评论管理</label> <button id="addevaltcomment" class="btn btn-primary btn-sm" type="button" style="margin-left:5%;width: 60px; height: 2em;">加评论</button>
            @for (int i = 0; i < 5; i++)
            {
                <div class="evaltcomment form-inline margin-top">
                    <div class="col-md-1"><label class="control-label mb-1 font-size evltcomnumber">@(i+1)</label></div>
                    <div class="col-md-10"><textarea type="text" name="Comments" class="Comments"></textarea></div>
                    <div class="col-md-1"><a class="fa fa-minus-circle text-danger delevltcomnumber"></a></div>

                </div>
                @*if (i == 0)
                    {
                        <div class="evaltcomment form-inline margin-left" style="margin-top:2%;">
                            <label class="control-label mb-1 font-size evltcomnumber">@(i+1)</label>
                            <textarea type="text" name="Comments" class="margin-left Comments"></textarea>
                        </div>
                    }
                    else
                    {
                        <div class="evaltcomment form-inline margin-top margin-left">
                            <label class="control-label mb-1 font-size evltcomnumber">@(i+1)</label>
                            <textarea type="text" name="Comments" class="margin-left Comments"></textarea>
                        </div>
                    }*@

            }
        </div>

        @*是否加精*@
        <div class="form-group">
            <label class="control-label mb-1" style="margin-right:3.5%;"></label>
            <input type="radio" id="stick" name="stick">是否加精(选中加精)@*<span style="font-size:8px;color:orangered">(评测发表时间为一天前，评论时间间隔较长)</span>*@
        </div>

        @*发布类型*@
        <div class="form-group">
            <label class="control-label mb-1" style="margin-right:3.5%;"></label>
            <input type="radio" id="comrelease" name="release" value="false" checked>发布<span style="font-size:8px;color:orangered">(评测发表时间为一天前，评论时间间隔较长)</span>
            <input type="radio" id="jjrelease" name="release" value="true">紧急发布<span style="font-size:8px;color:orangered">(评测发表时间为半小时前，所有评论时间在发表前半小时内，间隔小时太短，非时事类、紧急类建议不要选此发布方式。)</span>
        </div>

        @*操作按钮*@
        <div class="text-center">
            @*@if (Model.Status == 0)
                {
                    <button id="save" class="btn btn-primary btn-sm font-size" type="button" style="width:10%;height:2em;">发布</button>
                }
                else
                {
                    <button id="save" class="btn btn-primary btn-sm font-size" disabled="disabled" type="button" style="width:10%;height:2em; border-color:#b9c0c7;background-color:#b9c0c7;">发布</button>
                }*@
            <button id="save" class="btn btn-primary btn-sm font-size" type="button" style="width:10%;height:2em;">发布</button>
            <a href="@Url.Action("Index", new { queryJson = ViewBag.queryJson,page=ViewBag.page })" data-id="" class="text-info">返回列表</a>
        </div>

    </div>
</div>



@*需要预定义ue编辑器*@
<div class="border uecontent" id="preUE" hidden="hidden" placeholder="(提示:请录入图片和文字材料)" style="min-height:50px">
    <script id="editor1" type="text/plain" style="width:100%;height:200px;">
    </script>
</div>
<pre style="display:none;" id="tmp_Meal">@Html.Raw(Model == null ? "" :"" @*Model.Content*@)</pre>



@section Scripts{

    @*可搜索复选下拉框*@
    @*<script src="~/js/jqselect/jquery.min.js"></script>*@
    <script src="~/js/jqselect/select.js"></script>

    @*数据补全*@
    <script src="@(ViewBag.StaticFile)/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
    @*taginput*@
    <script src="@(ViewBag.StaticFile)/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>

    @*editor 富文本编辑器*@
    <script type="text/javascript" charset="utf-8" src="~/ueditor/ueditor.config.nostyle4cccv1.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/ueditor/editor_api.js"></script>


    <script src="~/js/jquery-validate.bootstrap-tooltip.min.js"></script>
    <script src="~/assets/js/GetFormJson.js"></script>
    <script src="~/assets/js/Completion.js"></script>
    @*<script src="~/js/schoolDataEnter.js?@(DateTime.Now.Ticks)"></script>*@
    <script src="~/js/jq.postJSON.js"></script>

    <script type="text/javascript">

         //ue编辑器
        var ue = UE.getEditor('editor1', {
            configPath: 'ueditor/config.json',
            initialContent: "",
            theme: 'tt',
            elementPathEnabled: !1,
            imageScaleEnabled: !1,
            imagePopup: !1,
            tableDragable: !1,
            wordCount: !1,
            autoHeight: false,
            toolbars: [["source", "h2", "bold", "underline", "italic", "strikethrough", "forecolor", "blockquote", "horizontal", "justifyleft", "justifycenter", "justifyright", "link", "unlink", "|", "insertimage", "|", "selectall", "removeformat", "undo", "redo"]],
            removeFormatTags: "b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,blockquote,h1,h2,h3,h4,h5,h6",
            autotypeset:
            {
                mergeEmptyline: !0,
                removeClass: !1,
                removeEmptyline: !0,
                pasteFilter: !0,
                clearFontSize: !0,
                clearFontFamily: !0
            },
        });
        ue.ready(function () {
            jQuery(this.container).click(function (e) {
                e.stopPropagation()
            });
            ue.execCommand('serverparam', 'contentID', '@(Model.Id)');
            ue.execCommand('serverparam', 'contentType', 'school_v3');
            ue.execCommand('cleardoc');
            ue.execCommand("insertHtml", '');
            //用于跳转判断
            isInit = true;
            ue.setContent(jQuery('#tmp_Meal').html());
        });
        jQuery('.uecontent').click(function (e) {
            e.stopPropagation();
            var jQuerytarget = jQuery(this);
            //解决多个ueditor切换后工具栏和输入框分离
            jQuery('.edui-editor-toolbarbox').attr('style', '');
            var content = jQuerytarget.html();
            var currentParnet = ue.container.parentNode.parentNode;
            var currentContent = ue.getContent();
            jQuerytarget.html('');
            jQuerytarget.append(ue.container.parentNode);
            ue.reset();
            setTimeout(function () {
                //用于跳转判断
                isInit = true;
                ue.setContent(content);
            }, 200)
            jQuery(currentParnet).html(currentContent);
            return false;
        });
        (function (b) {
            ue.ready(function () {
                if (b) return;
                b = true, bind_toolbar_event();
            });
            function bind_toolbar_event() {
                //ue 清除格式事件
                jQuery('.edui-editor').on('click', '.edui-for-removeformat', function () {
                    //用于跳转判断
                    isInit = true;
                    ue.setContent(rmStyle(ue.getContent()));
                });
            }
        })();

        jQuery(function () {
            UploadImg();
            downloadIamge();


        });


        //搜索下拉框
        //var searchSelect = (function () {
            //搜索复选下拉框--渲染初始话
            jQuery("#div_Special").mySelect();   //专题div_Special
            jQuery("#div_Org").mySelect();//机构div_Org
            jQuery("#div_Course").mySelect();//课程div_Course
            jQuery("#div_Duration").mySelect();//上课时长div_Duration
            jQuery("#div_Mode").mySelect();//上课方式
            jQuery("#div_Subject").mySelect();//科目div_Subject
            jQuery("#div_Age").mySelect();//年龄段div_Age



            //机构-课程联动
            jQuery(document).on('click touch', '#div_Org .select-picker-options-list-item', function (e) {
                e.preventDefault();
                //var orgids = jQuery(this).attr("id");
                var orgids = jQuery("#div_Org_hidden").val();
                SetCourseData(orgids, jQuery("#div_Course_select"));

            })
        function SetCourseData(orgId, jQueryselect) {
            debugger;
            if (orgId == null || orgId == 0) return;
            if (orgId.indexOf(',')>0) {//多选则不联动
                jQueryselect.empty();
                jQuery("#div_Course").mySelect();//课程div_Course
                ReRenderMySelect("div_Course");
            } else {
                jQuery.getJSON("@Url.Action("ChangeCourseData", "EvaluationCrawler")", { orgId: orgId }, function (data) {

                    var options = "";
                    jQuery.each(data, function (index, item) {
                        options += '<option value="' + item.value + '">' + item.text + '</option>';
                    });

                    jQuery("#div_Course .select-picker-search").each(function (index) {
                        jQuery(this).remove();
                    })
                    jQuery("#div_Course .select-picker-options-wrp").each(function (index) {
                        jQuery(this).remove();
                    })

                    jQueryselect.empty();
                    jQueryselect.append(options);
                    jQuery("#div_Course").mySelect();//课程div_Course
                    ReRenderMySelect("div_Course");
                });
            }

            }

            //选择已有课程
            @*jQuery(document).on('click touch', '#div_Course .select-picker-options-list-item', function (e) {
                e.preventDefault();
                var courseId = jQuery(this).attr("id");
                jQuery.getJSON("@Url.Action("ShowCourseById", "Courses")", { courseId: courseId }, function (d) {
                    //展示已有课程信息，隐藏自定义课程选项

                    //隐藏自定义相关
                    //课程名称
                    jQuery("#CourseName").val("").attr("hidden", "hidden")
                    jQuery("#CustomCourse").attr("hidden", "hidden").removeAttr("checked");
                    jQuery(".CustomCourse").attr("hidden", "hidden");//自定义课程勾选框
                    //上课时长
                    jQuery("#div_Duration").attr("hidden", "hidden");
                    jQuery("#div_Duration_hidden").val("");
                    //上课方式
                    jQuery("#div_Mode").attr("hidden", "hidden");
                    jQuery("#div_Mode_hidden").val("");
                    //科目分类
                    jQuery("#div_Subject").attr("hidden", "hidden");
                    jQuery("#div_Subject_hidden").val("");
                    //年龄段
                    jQuery("#div_Age").attr("hidden", "hidden");
                    jQuery("#div_Age_hidden").val("");

                    //展示已有课程（四个input）
                    jQuery("#Duration").val(d.duration).removeAttr("hidden")
                    jQuery("#Mode").val(d.modes).removeAttr("hidden")
                    jQuery("#Subject").val(d.subject).removeAttr("hidden")
                    jQuery("#Age").val(d.ageRange).removeAttr("hidden")
                });
            });*@

            //自定义课程
        //jQuery("#CustomCourse").on("click", function () {

        //    if (jQuery(this).attr("checked")) {
        //        debugger;
        //        //只是为了去掉勾选样式,不需做业务处理
        //    } else {
        //        debugger;
        //        //展示自定义课程相关项
        //        //课程名称
        //        jQuery("#CourseName").val("").removeAttr("hidden");//自定义课程名称
        //        jQuery("#CustomCourse").attr("checked", "checked").removeAttr("hidden");
        //        jQuery(".CustomCourse").removeAttr("hidden");//自定义课程勾选框
        //        //上课时长
        //        jQuery("#div_Duration").removeAttr("hidden");
        //        jQuery("#div_Duration_hidden").val("");

        //        //上课方式
        //        //jQuery("#div_Mode").removeAttr("hidden");
        //        //jQuery("#div_Mode_hidden").val("");
        //        ReRenderMySelect("div_Mode");//上课方式重置
        //        ReRenderMySelect("div_Mode");//上课方式重置

        //        //科目分类
        //        jQuery("#div_Subject").removeAttr("hidden");
        //        jQuery("#div_Subject_hidden").val("");
        //        //年龄段
        //        jQuery("#div_Age").removeAttr("hidden");
        //        jQuery("#div_Age_hidden").val("");

        //        jQuery("#div_Course").attr("hidden", "hidden");//课程下拉框隐藏，显示自定义课程名称输入框
        //        jQuery("#div_Course_hidden").val("");
        //        //隐藏已有课程（四个input）
        //        jQuery("#Duration").val("").attr("hidden", "hidden");
        //        jQuery("#Mode").val("").attr("hidden", "hidden");
        //        jQuery("#Subject").val("").attr("hidden", "hidden");
        //        jQuery("#Age").val("").attr("hidden", "hidden");
        //    }


        //    });



            //清除课程信息-包括（机构、课程、课程信息）--重置为最初状态
            //jQuery(".clear-courseInfo").on("click", function () {
            //    debugger;
            //    //课程下拉框显示，自定义课程名称输入框隐藏
            //    jQuery("#CourseName").val("").attr("hidden", "hidden");//自定义课程名称
            //    jQuery("#div_Course").removeAttr("hidden");


            //    if (jQuery("#CustomCourse").attr("checked")) {

            //        debugger;
            //        jQuery("#CustomCourse").click();
            //    }
            //    jQuery("#CustomCourse").removeAttr("hidden").removeAttr("checked");//自定义课程勾选显示
            //    jQuery(".CustomCourse").removeAttr("hidden");//自定义课程文本显示
            //    //隐藏已有课程（四个input）
            //    jQuery("#Duration").val("").attr("hidden", "hidden");
            //    jQuery("#Mode").val("").attr("hidden", "hidden");
            //    jQuery("#Subject").val("").attr("hidden", "hidden");
            //    jQuery("#Age").val("").attr("hidden", "hidden");


            //    //清空隐藏选中项value
            //    jQuery("#div_Org_hidden").val("");//机构
            //    jQuery("#div_Course_hidden").val("");//课程
            //    jQuery("#div_Duration_hidden").val("");//上课时长
            //    jQuery("#div_Mode_hidden").val("");//上课方式
            //    jQuery("#div_Subject_hidden").val("");//科目分类
            //    jQuery("#div_Age_hidden").val("");//年龄段


            //    jQuery("#div_Duration").removeAttr("hidden");
            //    jQuery("#div_Mode").removeAttr("hidden");
            //    jQuery("#div_Subject").removeAttr("hidden");
            //    jQuery("#div_Age").removeAttr("hidden");

            //    ReRenderMySelect("div_Org");//机构下拉框重置
            //    ReRenderMySelect("div_Course","");//课程下拉框重置
            //    ReRenderMySelect("div_Duration");//上课时长下拉框重置
            //    ReRenderMySelect("div_Mode");//上课方式重置
            //    ReRenderMySelect("div_Mode");//上课方式重置
            //    ReRenderMySelect("div_Subject");//科目分类重置
            //    ReRenderMySelect("div_Age");//年龄段下拉框重置
            //});
            //重新渲染下拉框
            function ReRenderMySelect(id, options) {
                
                jQuery("#" + id + " .select-picker-search").each(function (index) {
                    jQuery(this).remove();
                })
                jQuery("#" + id + " .select-picker-options-wrp").each(function (index) {
                    jQuery(this).remove();
                })

                //options包含选中项，则把选项传入,否则重置所有选项为未选中
                if (options == null || options == undefined) {
                    options = "";
                    jQuery("#" + id + "_select").find("option").each(function () {
                        var option = jQuery(this);
                        options += '<option  value="' + option.val() + '">' + option.text() + '</option>';
                    });
                }
                jQuery("#" + id + "_select").empty();
                jQuery("#" + id + "_select").append(options);
                jQuery("#" + id).mySelect();//重新渲染

            }


        //})();




        //发布类型，单选
        jQuery("input[name=release]").on("change", function () {
            jQuery(this).attr("checked", "checked");
            //互斥删除样式
            if (jQuery(this).val() == "true") {
                jQuery("#comrelease").removeAttr("checked");
            }
            else {
                jQuery("#jjrelease").removeAttr("checked");
            }

        });
        //是否加精
        jQuery("input[name=stick]").on("click", function () {
            jQuery(this).attr("checked", "checked");
        });



        //评论内容-----------------------

        //del
        jQuery(".delevltcomnumber").on("click", function () {
            jQuery(this).parents(".evaltcomment").remove();
            //重排序号
            jQuery(".evltcomnumber").each(function (index, n) {
                jQuery(n).text(index + 1);
            });

        });

        //add
        jQuery("#addevaltcomment").on("click", function () {
            var html = '<div class="evaltcomment form-inline margin-top"> <div class="col-md-1"><label class="control-label mb-1 font-size evltcomnumber" ></label></div><div class="col-md-10"><textarea type="text" name="Comments" class="Comments"></textarea></div><div class="col-md-1"><a class="fa fa-minus-circle text-danger delevltcomnumber"></a></div></div>';

            jQuery(this).after(html);
            jQuery(".delevltcomnumber").on("click", function () {
                jQuery(this).parents(".evaltcomment").remove();
                //重排序号
                jQuery(".evltcomnumber").each(function (index, n) {
                    jQuery(n).text(index + 1);
                });

            });


            //重排序号
            jQuery(".evltcomnumber").each(function (index, n) {
                jQuery(n).text(index + 1);
            });
        });

        //评论内容-----------------------


        //保存抓取评测
        jQuery("#save").on("click", function () {
            debugger;
            var data = GetFormData();//获取表单数据
            if (!(data.Title.trim())) {
                ShowAlert("标题不能为空");
                return;
            }

            if (!(data.Content.trim())) {
                    ShowAlert("正文不能为空");
                    return;
            }

            var overLength = false;
            jQuery(JSON.parse(data.Comments)).each(function (index, item) {

                if (item.length > 140) {
                    overLength = true;
                    return;
                }
            });
            if (overLength) {
                ShowAlert("单条评论内容不能超过140个字！");
                return;
            }


            var IsUrgent = jQuery("input[name=release][checked=checked]").val();
            data.IsUrgent = IsUrgent;
            showConfirm('确定发布？', function () {
                Loading("正在更新数据！");
                jQuery("#save").attr('disabled', 'disabled');
                jQuery.post("@Url.Action("AddEvlt")", data, function (result) {
                    debugger;
                    if (result.status ==200) {
                        ShowAlert("保存成功！", 1000, function () {
                            window.location.reload();
                        });
                    }
                    else {
                        ShowAlert(result.msg, -1);
                        CloseLoading();
                        jQuery("#save").removeAttr('disabled');
                    }
                });
            })
        });

        //获取表单数据
        function GetFormData() {
            var Id = '@Model.Id';//新增评测Id
            var Title = jQuery("#Title").val();//标题
            var Content = jQuery("#Content").val();//正文
            var Url = jQuery("#hidUrlJson").val();//图片集合
            var ThumUrl = jQuery("#hidThunUrlJson").val();//缩略图集合

            var Specialid = jQuery("#div_Special_hidden").val() == "" ? null : jQuery("#div_Special_hidden").val();//专题

            var listOrgId = [];
            var orgIds = jQuery("#div_Org_hidden").val() == "" ? null : jQuery("#div_Org_hidden").val();//机构
            if (orgIds != null) {               
                    listOrgId = orgIds.split(',');
            }
            var CourseId = null, CourseName = null, Duration = null, Mode = null, Subject = null, Age = null;
            //已有课程
            CourseId = jQuery("#div_Course_hidden").val() == "" ? null : jQuery("#div_Course_hidden").val();
            var listCourseId = [];
            if (CourseId != null) {
                listCourseId = CourseId.split(',');
            }
            //if (jQuery("#CustomCourse").attr("checked")) {
            //    debugger;
            //    //自定义课程
            //    CourseName = jQuery("#CourseName").val();//课程名称
            //    Duration = jQuery("#div_Duration_hidden").val() == "" ? null : jQuery("#div_Duration_hidden").val();//上课时长枚举
            //    var strmodes = jQuery("#div_Mode_hidden").val().split(',');
            //    var  Modes = [];//上课方式枚举
            //    jQuery(strmodes).each(function (index, mode) {
            //        if (mode!="")
            //            Modes.push(parseInt(mode));
            //    });
            //    Mode = Modes.length == 0 ? null : JSON.stringify(Modes);
            //    Subject = jQuery("#div_Subject_hidden").val() == "" ? null : jQuery("#div_Subject_hidden").val();//科目分类枚举
            //    Age = jQuery("#div_Age_hidden").val() == "" ? null : jQuery("#div_Age_hidden").val();//年龄段枚举
            //}
            //else {
            //    //已有课程
            //    CourseId = jQuery("#div_Course_hidden").val() == "" ? null : jQuery("#div_Course_hidden").val();
            //}

            var jsonComments = [];
            jQuery(".card-body textarea[name='Comments']").each(function (index, item) {
                if (jQuery(item).val().trim() == "") {
                    jQuery(item).parents(".evaltcomment").remove();
                }
                else {
                    jsonComments.push(jQuery(item).val());
                }

            });
            //重排评论序号
            jQuery(".evltcomnumber").each(function (index, n) {
                jQuery(n).text(index + 1);
            });
            var Comments = JSON.stringify(jsonComments);//课程价格
            //进行判断
            var data =
            {
                "Id": Id,
                "Title": Title,
                "Content": Content,
                "Url": Url,
                "ThumUrl": ThumUrl,
                "Specialid": Specialid,
                "ListOrgId": listOrgId,
                "ListCourseId": listCourseId,

                "CourseName": CourseName,
                "Duration": Duration,
                "Mode": Mode,
                "Subject": Subject,
                "Age": Age,
                "Comments": Comments,
                "IsStick": jQuery("#stick").attr("checked") == "checked" ? true : false,
                "IsUrgent": jQuery("input[name=release][checked]").val() == "true" ? true : false
            };
            return data;
        }


        //=====================图片=====================
        //1、上传
        function UploadImg()
        {
            //上传logo--选择图片
            jQuery('.updateBtn').click(function () {
                //最多上传10张
                var Url = JSON.parse(jQuery("#hidUrlJson").val());//图片集合
                debugger;
                if (Url.length >= 10) {
                    ShowAlert('最多上传10张图片');
                    return;
                }
                return jQuery('#' + jQuery(this).attr('data-video')).click(); //注意这句，主要是需要return点击事件返回值
            });
            //上传logo--自动上传
            jQuery('.updateFile').on("change", function () {

                var fileinput = jQuery(this);//上传文件
                var videoInput = fileinput.attr('id');
                var jQueryvideoInput = document.getElementById(videoInput);
                if (jQueryvideoInput.files.length == 0) {
                    return;
                }
                var formData = new FormData();
                for (var i = 0; i < jQueryvideoInput.files.length; i++) {
                    formData.append(videoInput, jQueryvideoInput.files[i]);
                }
                Loading("正在上传图片！");
                 jQuery.ajax({
                    url: "@ViewBag.OrgeEvltCrawlerUploadUrl",
                    type: "post",
                    data: formData,
                    processData: false,
                    contentType: false,
                    cache: false
                }).done(function (res) {
                    debugger;
                    if (res.status == 200) {
                        ShowAlert('上传成功', 1000, function () {
                            fileinput.val('');
                                debugger;
                            var url = res.data.src;
                            var url_s = res.data.src_s;
                            AddUrl(url, url_s)
                            ReloadImg();

                        });

                    } else {
                        ShowAlert("上传失败:"+res.msg, -1);
                        CloseLoading();
                    }
                    CloseLoading();
                }).fail(function (res) {
                    ShowAlert("网络异常:"+res.msg, -1);
                    CloseLoading();
                });
            })
        }

        //2、删除图片
        jQuery("body").delegate(".deletebutten", "click", function () {
            var jQueryinput = jQuery(this);
            var delUrl = jQueryinput.attr("data-input");//url
            var json = JSON.parse(jQuery("#hidUrlJson").val());
            var jsonResult = [];
            debugger;
            jQuery.each(json, function (index, url) {
                if (url != delUrl) {
                    jsonResult.push(url);
                }
                else {
                    debugger;
                    var thundata = JSON.parse(jQuery("#hidThunUrlJson").val());
                    thundata.splice(index, 1);
                    jQuery("#hidThunUrlJson").val(JSON.stringify(thundata));
                }
            });
            jQuery("#hidUrlJson").val(JSON.stringify(jsonResult));
            GetImgHtml(jsonResult);
        });

        //3、下载
        function downloadIamge() {//下载图片地址和图片名
            jQuery(".downloadpic").on("click", function () {
                var jQueryaimg = jQuery(this);
                var url = jQueryaimg.attr('data-input');
                var fileName = url.split(/(\\|\/)/g).pop();

                forceDownload(url, fileName);

            });

        }
        function forceDownload(url, fileName) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "blob";
            xhr.onload = function () {
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(this.response);
                var tag = document.createElement('a');
                tag.href = imageUrl;
                tag.download = fileName;
                document.body.appendChild(tag);
                tag.click();
                document.body.removeChild(tag);
            }
            xhr.send();
        }

        //重新渲染图片
        function ReloadImg() {
            var data = JSON.parse(jQuery("#hidUrlJson").val());
            GetImgHtml(data);
        }
        function GetImgHtml(data) {
             var html = '<div class="row img-margin-left">';
            jQuery(data).each(function (index, url) {

                //img
                html +=' <div class="col-md-2">'
                     +'     <div class="form-inline">'
                     +'        <a class="delrankbtn fa fa-minus-circle deletebutten  text-danger" data-input="'+url+'"></a>'
                     +'        <img style="width:100px;height:100px;" src="'+url+'">'
                     +'       </div>'
                     +'       <div class="form-inline">'
                     + '           <div id="' + url +'" class="col-md-7" style="text-align:center;">'
                    + '               <a href="javascript:void(0)" data-id="" class="downloadpic text-info"   data-input="' + url +'" >下载</a>  '
                     +'           </div>'
                     +'           <div class="col-md-5"></div>'
                     +'      </div>'
                    + '    </div>'
                //next row  i+1
                if ((index + 1) % 4 == 0) {
                    html += '</div><div class="row img-margin-left">';
                }

            });
            //i=data.length-1,上传按钮
            html+= '    <div class="col-md-2">'
                + '        <input type="file" id="@Model.Id" hidden="hidden" class="c_ignore updateFile" name="files" multiple="" accept="jpg,png" title="只允许上传Mp4格式的视频!视频大小不能超过40M">'
                + '            <input type="button" id="uploadlogo" style="width: 100px; height: 100px; font-size: 50px;" class="uploadvideo-btn btn  btn-info btn-block c_ignore updateBtn" data-video="@Model.Id" data-input="InterviewVideos" value="+">'
                + '</div>';
            html += '</div>';
            jQuery("#img-list").html(html);
            UploadImg();
            downloadIamge();
        }

        //原图、缩略图集合增加图片地址
        function AddUrl(url, thunurl) {
            debugger;
            var Url = JSON.parse(jQuery("#hidUrlJson").val());//图片集合
            var ThumUrl = JSON.parse(jQuery("#hidThunUrlJson").val());;//缩略图集合

            Url.push(url);
            ThumUrl.push(thunurl);
            jQuery("#hidUrlJson").val(JSON.stringify(Url));
            jQuery("#hidThunUrlJson").val(JSON.stringify(ThumUrl));
        }

    </script>
}
