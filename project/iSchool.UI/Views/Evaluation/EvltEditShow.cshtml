@using iSchool.Organization.Appliaction.ViewModels
@using iSchool.Infrastructure;
@using iSchool.Organization.Domain.Enum;
@using X.PagedList.Mvc.Core;
@using X.PagedList;
@using X.PagedList.Mvc.Common;
@model EvalUpdateShowDto
@{
    ViewData["Title"] = "评测内容";

    //var pagecount = Math.Ceiling(Model.ListEvltComments.PageCount * 1.0 / Model.ListEvltComments.PageSize);//总页数
}

@section css
{
    <link href="@(ViewBag.StaticFile)/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">
    <link href="@(ViewBag.StaticFile)/cropper/4.0.0-beta/cropper.min.css" rel="stylesheet">

    <link href="~/lib/cropper/main.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet">

    <link href="https://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">

    @*可搜索复选下拉框*@
    <link href="~/css/jsselect/select.css" rel="stylesheet" />

    <style type="text/css">
        /*tags样式*/
        .label-info {
            display: inline-block;
            padding: 2px 4px;
            font-size: 11.844px;
            font-weight: bold;
            line-height: 14px;
            text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
            white-space: nowrap;
            vertical-align: baseline;
            background-color: #3a87ad;
            margin-right: 2px;
            color: white;
        }

        .bootstrap-tagsinput {
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
            /*display: inline-block;*/
            /*padding: 4px 6px;*/
            padding: .375rem .75rem;
            color: #555;
            vertical-align: middle;
            border-radius: 4px;
            max-width: 100%;
            line-height: 22px;
            cursor: text;
            width: 100%;
        }

        .str {
            width: 150px;
            height: 200px;
            border: solid 1px #e3e3e3;
            padding: 5px;
            margin-top: 10px
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            -moz-border-radius: 40px; /* 老的 Firefox */
        }

        .typeahead {
            z-index: 1051;
        }

        .a-href {
            cursor: pointer;
        }

        .c_contain {
        }

        .c_value {
        }
        .deletebutten {
            position: absolute;
            display: block;
            width: 5px;
            height: -6px;
            top: 0px;
            right: 88px;
        }

         .delvideo {
            position: absolute;
            display: block;
            width: 5px;
            height: -6px;
            top: 0px;
            right: 88px;
            margin-left:10%;
        }

        .side-bar {
            position: fixed;
            bottom: 100px;
            right: 25px;
            font-size: 0;
            line-height: 0;
            z-index: 100;
        }

            .side-bar a {
                width: 66px;
                height: 66px;
                display: inline-block;
                margin-bottom: 2px;
            }


            .side-bar .icon-right {
                background-position: 0 -62px;
            }

        #auditcard {
            width: 500px;
        }

        @if (!Context.HasCtrlActQyx("school", "ExtFieldsSync", ".sync"))
        {
            <text >
        .sync {
            display: none;
        }

            </text>
        }

        .margin-top {
            margin-top: 2%;
        }
        .margin-left {
            margin-left: 5%;
        }

        .font-size {
            font-size:20px;
        }

        .img-margin-left {
            margin-left: 3%;
        }
        .downloadpic{
            font-size:1px;
        }
        .Comments {
            width: 90%;
        }

    </style>
}
@*评论数据预加载*@
<pre id="pgjson1" style="display:none;">@(Model.ListEvltComments.ToJsonString(true))</pre>
<div class="card">
    <div class="card-header">
        <div class="form-inline">
            <div class="text-left col-md-6 ">内容编辑</div>
            <div class="text-right col-md-6">
                <a href="@Url.Action("Index", new { queryJson = ViewBag.queryJson,page=ViewBag.page })" data-id="" class="text-info">返回列表</a>
            </div>
        </div>

    </div>
    <div class="card-body">

        @*标题*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">标题：</label>
                <input type="text" name="ETitle" id="ETitle" value="@Model.ETitle" class="form-control" style="width:50%;" />
            </div>
        </div>
        @*专题*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">专题：</label>
                <div id="div_Special" class="selectPickerWrapper">
                    <select id="div_Special_select" class="hidden">
                        @if (Model.ListSpecials?.Any() == true)
                        {
                            foreach (var item in Model.ListSpecials)
                            {
                                if (Model.Specialid?.ToString() == item.Value.ToLower())
                                {
                                    <option value="@item.Value" data-id="duihao-checked">@item.Text</option>
                                }
                                else
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }

                            }
                        }
                    </select>
                </div>
            </div>
        </div>

        @*机构、课程*@
        <div class="form-group">
            <div class="form-inline">
                <label class="control-label mb-1">机构：</label>
                <div id="div_Org" class="selectPickerWrapper" multiple="multiple">
                    <select id="div_Org_select" class="hidden">
                        @if (Model.ListOrgs?.Any() == true)
                        {
                            var oldOrgids = Model.ListEvltBind.Select(_ => _.Orgid.ToString().ToLower()).ToList();
                            foreach (var item in Model.ListOrgs)
                            {
                                if (oldOrgids.Contains(item.Value.ToLower()))
                                {
                                    <option value="@item.Value" data-id="duihao-checked">@item.Text</option>
                                }
                                else
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }

                            }
                        }
                    </select>
                </div>
                <label class="control-label mb-1">课程：</label>
                @*<input type="text" @(Model.Courseid != null ? "hidden" : "") name="CourseName" id="CourseName" class="form-control" placeholder="请输入自定义课程名称" value="@Model.CourseName" style="" />*@
                <div id="div_Course" class="selectPickerWrapper" multiple="multiple">
                    <select id="div_Course_select" class="hidden">
                        @if (Model.ListCourses?.Any() == true)
                        {
                            var oldCourseids = Model.ListEvltBind.Select(_ => _.Courseid.ToString().ToLower()).ToList();
                            foreach (var item in Model.ListCourses)
                            {
                                if (oldCourseids.Contains(item.Value.ToLower()))
                                {
                                    <option value="@item.Value" data-id="duihao-checked">@item.Text</option>
                                }
                                else
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }

                            }
                        }
                    </select>
                </div>
                <label class="control-label mb-1" style="color:red; font-size:10px;">注：机构单选时，机构-课程才联动且课程可选；机构多选则课程不可选</label>
                <!--<input type="checkbox" id="CustomCourse" name="CustomCourse" hidden="hidden"><span class="CustomCourse" hidden="hidden">自定义课程</span>
                <label class="control-label mb-1 margin-left" id="courseType">类型：</label>
                <a href="javascript:void(0)" class="margin-left clear-courseInfo" style="border-bottom: 1px solid #00a0ff; color: #00a0ff;">清除课程信息</a>-->
                @*业务TODO*@
            </div>
        </div>

        @*课程信息：已有课程(Model.Courseid != null)，则以下四项都是只读；自定义课程，则可选*@
        <!--<div class="form-group">
            <div style="border: 1px solid #ccc;">
                <label class="control-label mb-1" style="margin-top: 20px; margin-left: 35px; ">课程信息：</label>
                <div class="form-inline margin-top" style="margin-left: -2.4%; margin-bottom: 3%;">-->
        @*上课时长--单选或文本框*@
        <!--<label class="control-label mb-1 margin-left">上课时长：</label>
        <input type="text" id="Duration" readonly="readonly" style="width:150px;" value="" class="form-control" />
        <div id="div_Duration" class="selectPickerWrapper">
            <select id="div_Duration_select" class="hidden">

            </select>
        </div>-->
        @*上课方式--复选或文本框*@
        <!--<label class="control-label mb-1" style="margin-left:1%;">上课方式：</label>
        <input type="text" id="Mode" readonly="readonly"  style="width:250px;" value="" class="form-control" />
        <div id="div_Mode" class="selectPickerWrapper" multiple="multiple">
            <select id="div_Mode_select" class="hidden">

            </select>
        </div>-->
        @*科目分类--单选或文本框*@
        <!--<label class="control-label mb-1" style="margin-left:1%;">科目分类：</label>
        <input type="text" id="Subject" readonly="readonly" style="width:150px;" value="" class="form-control" />
        <div id="div_Subject" class="selectPickerWrapper" >
            <select id="div_Subject_select" class="hidden">

            </select>
        </div>-->
        @*年龄段--已有课程：只读最小最大年龄文本框；自定义课程年龄段单选*@
        <!--<label class="control-label mb-1" style="margin-left:1%;">年龄段：</label>
                    <input type="text" id="Age" readonly="readonly" style="width:150px;" value="" class="form-control" />
                    <div id="div_Age" class="selectPickerWrapper" >
                        <select id="div_Age_select" class="hidden">

                        </select>
                    </div>

                </div>
            </div>
        </div>-->
        @*图片*@
        <div class="form-group piclist">

            @foreach (var item in Model.ListEvaluationItems)
            {
                <label class="control-label mb-1">@(item.Type > 0 ? $"步骤{item.Type}图片：" : "图片：" )</label>
                <div id="@("img-list-"+item.Type)">
                    @if (!string.IsNullOrEmpty(item.Thumbnails))
                    {
                        @*@Html.Raw(ViewBag.UrlHtml)*@
                        @Html.Raw(Model.DicUrlHtml[item.Type])
                    }
                    else
                    {
                        //上传按钮
                        <div class="col-md-2">
                            <input type="file" id="@(Model.Id+"|"+item.Type)" hidden="hidden" class="c_ignore updateFile" name="files" multiple accept="jpg,png" title="只允许上传Mp4格式的视频!视频大小不能超过40M" />
                            <input type="button" id="@("uploadlogo-"+item.Type)" style="width: 100px; height: 100px; font-size: 50px;" class="uploadvideo-btn btn  btn-info btn-block c_ignore updateBtn" data-video="@Model.Id" data-input="InterviewVideos" value="+" />
                        </div>
                    }
                </div>
                <input type="text" class="hidUrlJson" id="@("hidUrlJson-"+item.Type)" hidden="hidden" value="@item.Pictures" />
                <input type="text" class="hidThunUrlJson" id="@("hidThunUrlJson-"+item.Type)" hidden="hidden" value="@item.Thumbnails" />
                <input type="text" class="hidevltItemIds" hidden="hidden" value="@item.Id" />
            }

        </div>

        @*视频*@
        <div class="form-group">
            <label class="form-control-label">视频</label>
            <div class="div_vdo" ui-batch-uploadvideo="1" data-title="视频">
                <div id="videshow" vdo="" class="row">
                    @if (!string.IsNullOrEmpty(Model.ListEvaluationItems[0].Video))
                    {

                        <div id="" class="col-md-4">
                            <div class="row ppvideo">
                                <div class="col-md-4">
                                    <video class="vdo_vdo" style="object-fit:cover;" width="250" height="150" controls="" data-id="a492dd5d-75ea-4ed8-8860-2d75a6755b71" poster="@(Model.ListEvaluationItems[0].VideoCover)">
                                        <source src="@(Model.ListEvaluationItems[0].Video)" type="video/mp4">
                                    </video>
                                </div>
                                @*删除*@
                                <div class="col-md-6"><a id="delvideo" class="fa fa-minus-circle delvideo text-danger"></a></div>
                            </div>
                            <a href="javascript:void(0)" id="downlvideo" data-id="" class="downloadpic text-info" data-input="@(Model.ListEvaluationItems[0].Video)">下载</a>
                        </div>
                    }
                </div>

                <div item-add="" class="row">
                    <div class="col-md-4">
                        <input type="file" name="principalvideo" multiple="" accept="video/mp4,audio/mp4" title="只允许上传Mp4格式的视频!视频大小不能超过40M">
                    </div>
                    <div class="col-md-2">
                        <input type="button" id="uploadsinglevideo" class="uploasingledvideo btn btn-info btn-block" data-video="principalvideo" data-input="principalvideo" value="上传">
                    </div>
                    <div class="col-md-6">
                        <a href="javascript:;" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="只允许上传Mp4格式的视频!视频大小不能超过40M">
                            <i class="fa fa-question-circle"></i>视频格式
                        </a>
                    </div>
                </div>
            </div>
        </div>

        @*正文*@
        <div class="form-group">
            @foreach (var item in Model.ListEvaluationItems)
            {
                <div class="form-inline">
                    <label class="control-label mb-1" style="">@(item.Type > 0 ? $"步骤{item.Type}正文：" : "正文：" )</label>
                    <textarea class="Content" id="@("Content-"+item.Type)" name="@("Content-"+item.Type)" rows="10" cols="150">@item.Content</textarea>
                </div>
            }
        </div>

        <hr />
        @*评论抓取*@
        <div class="form-group">
            <label class="control-label mb-1">评论管理：</label>
            <div id="tb"></div>
        </div>

        @*是否加精*@
        @*<div class="form-group">
                <label class="control-label mb-1" style="margin-right:3.5%;"></label>
                @if (Model.Stick)
                {
                    <input type="radio" id="stick" checked="checked" name="stick">
                }
                else
                {
                    <input type="radio" id="stick" name="stick" />
                }
                是否加精(选中加精)

            </div>*@

        @*操作按钮*@
        <div class="text-center">
            <button id="save" class="btn btn-primary btn-sm font-size" type="button" style="width:10%;height:2em;">确定</button>
            <a href="@Url.Action("Index", new { queryJson = ViewBag.queryJson,page=ViewBag.page })" data-id="" class="text-info">返回列表</a>
        </div>
    </div>
</div>


@*回复模态窗体*@
<div class="modal fade" id="myAddModal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myAddModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myAddModalLabel">
                    查看回复
                </h4>
            </div>
            <div class="modal-body">
                @*动态加载回复到此处*@
                <div id="repelyshow" data-evltid="@Model.Id" class="form-group">
                    @*<div class="evaltcomment form-inline margin-top">
                            <div class="col-md-1"><label class="control-label mb-1 font-size evltcomnumber">@(i+1)</label></div>
                            <div class="col-md-10"><textarea type="text" name="Comments" class="Comments"></textarea></div>
                            <div class="col-md-1"><a class="fa fa-minus-circle text-danger delevltcomnumber"></a></div>

                        </div>*@
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-isadd="" id="update-reply" data-id="">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>

            </div>
        </div>
    </div>
</div>

@*需要预定义ue编辑器*@
<div class="border uecontent" id="preUE" hidden="hidden" placeholder="(提示:请录入图片和文字材料)" style="min-height:50px">
    <script id="editor1" type="text/plain" style="width:100%;height:200px;">
    </script>
</div>
<pre style="display:none;" id="tmp_Meal">@*@Html.Raw(Model == null ? "" : Model.Content)*@</pre>


<script id="tmp_tb" type="text/template">
    <%
    var pages = data.currentPageItems;
    %>
    <div class="row">
        <div class="col-sm-12">
            <table id="bootstrap-data-table-export" class="table table-striped table-bordered dataTable no-footer" role="grid" aria-describedby="bootstrap-data-table-export_info">
                <thead class="tbheader">
                    <tr role="row" style="text-align:center">
                        <th class="sorting_asc" tabindex="0" aria-controls="bootstrap-data-table-export" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 5%;">
                            序号
                        </th>
                        <th class="sorting" tabindex="0" aria-controls="bootstrap-data-table-export" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width:75%;">
                            评论内容
                        </th>
                        <th class="sorting" tabindex="0" aria-controls="bootstrap-data-table-export" rowspan="1" colspan="1" aria-label="Position: activate to sort column ascending" style="width:10%;">
                            回复详情
                        </th>
                        <th class="sorting" tabindex="0" aria-controls="bootstrap-data-table-export" rowspan="1" colspan="1" aria-label="Office: activate to sort column ascending" style="width: 5%;">

                        </th>
                    </tr>
                </thead>
                <tbody>
                    <% for (var i = 0, c = pages.length; i < c; i++) { %>
                    <tr role="row" class="odd" style="text-align:center">
                        <td><label style="margin-top:60%;"><%= pages[i].rowNum %></label></td>
                        <td><textarea type="text" class="form-control commentlistmanager" id="<%= pages[i].id %>" name="<%= pages[i].id %>"><%= pages[i].comment%></textarea></td>
                        <td><label class="replydetails" style="border-bottom: 1px solid #00a0ff; color: #00a0ff; margin-top:25%;" data-evlid="@Model.Id" data-comid="<%= pages[i].id %>">查看</label></td>
                        <td><label style="margin-top:60%;"><%= pages[i].isOfficial==true?"后台":"原创" %></label></td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12 col-md-3">
            <div class="dataTables_info" id="bootstrap-data-table-export_info" role="status" aria-live="polite">
                @*显示 <%=(data.currentPageIndex-1)*data.pageSize+1 %> 到 <%=data.currentPageIndex*data.pageSize %> 条*@
                总共 <%=data.totalItemCount %> 条
            </div>
        </div>
        <div class="col-sm-12 col-md-9">
            <div class="dataTables_paginate paging_simple_numbers" id="div_pager">
            </div>
        </div>
    </div>
</script>


@section Scripts{

    @*可搜索复选下拉框*@
    <script src="~/js/jqselect/select.js"></script>

    @*数据补全*@
    <script src="@(ViewBag.StaticFile)/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
    @*taginput*@
    <script src="@(ViewBag.StaticFile)/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>

    @*editor 富文本编辑器*@
    <script type="text/javascript" charset="utf-8" src="~/ueditor/ueditor.config.nostyle4cccv1.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/ueditor/editor_api.js"></script>

    <script src="~/js/jquery-validate.bootstrap-tooltip.min.js"></script>
    <script src="~/assets/js/GetFormJson.js"></script>
    <script src="~/assets/js/Completion.js"></script>
    <script src="~/js/jq.postJSON.js"></script>

    @*异步分页*@
    <script src="~/js/bootstrap-pager.js"></script>
    <script src="~/js/jq.postJSON.js"></script>
    <script src="~/js/microTemplate.js"></script>


    <script type="text/javascript">
        var ui_batch_uploadVideo = []; //[(type,uiobj)]
        jQuery(function () {
            UploadImg();
            downloadIamge();

            //列表+查询
            var reload = (function ($, render) {

                var o = {};
                o.pageSize = 5;
                o.pageIndex = 1;
                o.searchType = 0;
                o.evltId = '@Model.Id'

                var bus = new LiejiaJS.event();
                var msgType = {
                    relist: 're-list',
                };



                var tmp = $('#tmp_tb').html();

                function ui2o() {

                    $('[prop]').each(function (t) {
                        t = $(this);
                        o[t.attr('prop')] = t.val() || undefined;
                    });
                }

                function init(data) {

                    console.log('init and rendering tb with str ...');
                    var str = render(tmp, data);
                    console.log('render tb str ok');
                    $('#tb').html(str);

                    $('#div_pager').page({
                        count: data.totalItemCount,
                        pageNum: o.pageIndex,
                        pageSize: o.pageSize,
                        canSkip: true,
                    }).$element.on('pageChanged', function (e, p) {
                        o.pageIndex = p.pageNum;
                        ui2o(), ajax();
                    });
                    bus.emit(msgType.relist, 1);

                    //评论内容实时入库focus
                    var focusVal = "";
                    var blurVal = "";
                    jQuery(".commentlistmanager").focus(function () {
                        focusVal = $(this).val();
                    }).blur(function () {
                        var currenttextarea = $(this);
                        blurVal = currenttextarea.val();
                        if (focusVal != blurVal) {
                            if (currenttextarea.val().trim().length == 0) {
                            ShowAlert("评论内容不允许为空！");
                            return;
                        }
                        else if (currenttextarea.val().trim().length > 140) {
                            ShowAlert("单条评论内容不能超过140个字！");
                            return;
                        }
                        var request = { "Id": currenttextarea.attr("id"), "EvltId": '@Model.Id', "Comment": currenttextarea.val() }
                            $.postJSON('/Evaluation/UpdateCommentById', request, function (result) {

                            if (result.status == 200) {
                                init(result.data);
                            } else {
                                ShowAlert(result.msg, -1);
                                return console.log(result);
                            }
                        });
                        }
                    });

                    //回复相关事件和查看回复按钮事件
                    //删除修改属性
                    function RemoveChangeAttr() {
                        jQuery(".replys").each(function (index, d) {
                            jQuery(d).removeAttr("data-change");
                        });
                    }
                    jQuery(".replydetails").on("click", function () {
                        var comid = jQuery(this).attr("data-comid");
                        jQuery.postJSON('/Evaluation/ReplyList', { "ComId": comid }, function (res) {

                            if (!res.isOk) {
                                ShowAlert('网络异常');
                                return console.log(res);
                            } else {
                                var count = res.data.length;
                                if (count == 0) {
                                    ShowAlert('暂无回复数据');
                                } else {
                                    var newHtml = "";
                                    for (var i = 0; i < count; i++) {
                                        newHtml += "<div class='commentreply form-inline margin-top'>";
                                        newHtml += "    <div class='col-md-1'><label class='control-label mb-1 font-size evltcomnumber'>" + res.data[i].rowNum + "</label></div>";
                                        newHtml += "    <div class='col-md-11'><textarea style='width:100%;' data-replyid='" + res.data[i].id + "' type='text' name='reply' class='replys form-control'>" + res.data[i].comment + "</textarea></div>";
                                        //newHtml += "    <div class='col-md-1'><a class='fa fa-minus-circle text-danger delevltcomnumber'></a></div>";
                                        newHtml += "</div>";
                                    }
                                    jQuery("#repelyshow").html("").html(newHtml);
                                    RemoveChangeAttr();
                                    textareaChange();
                                    jQuery("#myAddModal").modal('show');
                                }
                            }
                        });

                    });
                    function textareaChange() {
                        var focusValue = "";
                        var blurValue = "";
                        jQuery(".replys").focus(function () {

                            focusValue = jQuery(this).val();
                        }).blur(function () {

                            blurValue = jQuery(this).val();
                            if (blurValue.trim().length == 0) {
                                ShowAlert("回复内容不允许为空！");
                                jQuery(this).focus();
                                return;
                            }
                            if (focusValue != blurValue) {//回复被修改需标识
                                jQuery(this).attr("data-change", "true");
                            }
                            //else {
                            //    jQuery(this).removeAttr("data-change");
                            //}
                        });
                    }

                    //保存修改回复
                    jQuery("#update-reply").on("click", function () {

                        var evltId = jQuery("#repelyshow").attr("data-evltid");
                        var postData = { "EvltId": evltId, "ListReplys": [] };
                        jQuery(".replys[data-change=true]").each(function (index, r) {

                            postData.ListReplys.push({ "Id": jQuery(r).attr("data-replyid"), "Comment": jQuery(r).val() })
                        });
                        if (postData.ListReplys.length == 0) {
                            ShowAlert("回复内容没有变更", 3000);
                            return;
                        }
                        jQuery.postJSON('/Evaluation/BatchUpdateRelpsById', postData, function (result) {

                            if (result.status == 200) {
                                jQuery("#myAddModal").modal('hide');

                            } else {
                                ShowAlert(result.msg, -1);
                                return console.log(result);
                            }
                            RemoveChangeAttr();
                        });
                    })


                }

                function ajax() {
                    $.postJSON('/Evaluation/EvaluationCommentList', o, function (res) {
                        if (!res.isOk) {
                            ShowAlert('网络异常');
                            return console.log(res);
                        } else {
                            init(res.data);
                        }
                    });
                }



                $('#btn1').click(function () {
                    o.pageIndex = 1, o.searchType = 0, ui2o(), ajax();
                });
                $('#btn2').click(function () {
                    //$('[prop=idOrName]').val('');
                    o.pageIndex = 1, o.searchType = 1, ui2o(), ajax();
                });
                $('#btn2c').click(function () {
                    $('[prop=idOrName]').val('');
                    $('#div_searchC [prop]').each(function () { $(this).val('') });
                    jQuery('#div_searchC [prop=area1]').val(-1);
                    jQuery('#div_searchC [prop=area2]').val(-1);
                    jQuery('#div_searchC [prop=area3]').val(-1);
                });

                var dt1 = JSON.parse($('#pgjson1').html());
                console.log(dt1);
                $('#pgjson1').remove();
                if (dt1) {

                    init(dt1);
                } else {

                    init({
                        currentPageIndex: o.pageIndex,
                        pageSize: o.pageSize,
                        totalItemCount: 0,
                        totalPageCount: 0,
                        currentPageItems: [],
                    });
                    ajax();
                }

                return function () { ui2o(), ajax() };
            })(jQuery, microTemplate);

            //回复
            var reply = (function () {

                ////删除修改属性
                //function RemoveChangeAttr() {
                //    jQuery(".replys").each(function (index, d) {
                //        jQuery(d).removeAttr("data-change");
                //    });
                //}
                //jQuery(".replydetails").on("click", function () {
                //    var comid = jQuery(this).attr("data-comid");
                //    jQuery.postJSON('/Evaluation/ReplyList', { "ComId": comid }, function (res) {

                //        if (!res.isOk) {
                //            ShowAlert('网络异常');
                //            return console.log(res);
                //        } else {
                //            var count = res.data.length;
                //            if (count == 0) {
                //                ShowAlert('暂无回复数据');
                //            } else {
                //                var newHtml = "";
                //                for (var i = 0; i < count; i++) {
                //                    newHtml += "<div class='commentreply form-inline margin-top'>";
                //                    newHtml += "    <div class='col-md-1'><label class='control-label mb-1 font-size evltcomnumber'>" + res.data[i].rowNum + "</label></div>";
                //                    newHtml += "    <div class='col-md-11'><textarea style='width:100%;' data-replyid='" + res.data[i].id + "' type='text' name='reply' class='replys form-control'>" + res.data[i].comment + "</textarea></div>";
                //                    //newHtml += "    <div class='col-md-1'><a class='fa fa-minus-circle text-danger delevltcomnumber'></a></div>";
                //                    newHtml += "</div>";
                //                }
                //                jQuery("#repelyshow").html("").html(newHtml);
                //                RemoveChangeAttr();
                //                textareaChange();
                //                jQuery("#myAddModal").modal('show');
                //            }
                //        }
                //    });

                //});
                //function textareaChange() {
                //    var focusValue = "";
                //    var blurValue = "";
                //    jQuery(".replys").focus(function () {
                //
                //        focusValue = jQuery(this).val();
                //    }).blur(function () {
                //
                //        blurValue = jQuery(this).val();
                //        if (blurValue.trim().length == 0) {
                //            ShowAlert("回复内容不允许为空！");
                //            jQuery(this).focus();
                //            return;
                //        }
                //        if (focusValue != blurValue) {//回复被修改需标识
                //            jQuery(this).attr("data-change", "true");
                //        } else {
                //            jQuery(this).removeAttr("data-change");
                //        }
                //    });
                //}

                ////保存修改回复
                //jQuery("#update-reply").on("click", function () {
                //
                //    var evltId = jQuery("#repelyshow").attr("data-evltid");
                //    var postData = { "EvltId": evltId,"ListReplys":[]};
                //    jQuery(".replys[data-change=true]").each(function (index, r) {
                //
                //        postData.ListReplys.push({ "Id": jQuery(r).attr("data-replyid"), "Comment": jQuery(r).val() })
                //    });
                //    if (postData.ListReplys.length == 0) {
                //        ShowAlert("回复内容没有变更", 3000);
                //        return;
                //    }
                //    jQuery.postJSON('/Evaluation/BatchUpdateRelpsById', postData, function (result) {
                //
                //        if (result.status == 200) {
                //            jQuery("#myAddModal").modal('hide');

                //        } else {
                //            ShowAlert(result.msg, -1);
                //            return console.log(result);
                //        }
                //        RemoveChangeAttr();
                //    });
                //})

            })();

            //单选、复选
            var singlecheckselect = (function () {

                //搜索复选下拉框--渲染初始话
                jQuery("#div_Special").mySelect();   //专题div_Special
                jQuery("#div_Org").mySelect();//机构div_Org
                jQuery("#div_Course").mySelect();//课程div_Course
                jQuery("#div_Duration").mySelect();//上课时长div_Duration
                jQuery("#div_Mode").mySelect();//上课方式
                jQuery("#div_Subject").mySelect();//科目div_Subject
                jQuery("#div_Age").mySelect();//年龄段div_Age

                //清除课程信息-包括（机构、课程、课程信息）
                //jQuery(".clear-courseInfo").on("click", function () {

                //    //清除课程类型
                //    jQuery("#courseType").remove();
                //    //课程下拉框显示，自定义课程名称输入框隐藏
                //    jQuery("#CourseName").val("").attr("hidden", "hidden");//自定义课程名称
                //    jQuery("#div_Course").removeAttr("hidden");


                //    if (jQuery("#CustomCourse").attr("checked")) {
                //        jQuery("#CustomCourse").click();
                //    }
                //    jQuery("#CustomCourse").removeAttr("hidden").removeAttr("checked");//自定义课程勾选显示
                //    jQuery(".CustomCourse").removeAttr("hidden");//自定义课程文本显示
                //    //隐藏已有课程（四个input）
                //    jQuery("#Duration").val("").attr("hidden", "hidden");
                //    jQuery("#Mode").val("").attr("hidden", "hidden");
                //    jQuery("#Subject").val("").attr("hidden", "hidden");
                //    jQuery("#Age").val("").attr("hidden", "hidden");


                //    //清空隐藏选中项value
                //    jQuery("#div_Org_hidden").val("");//机构
                //    jQuery("#div_Course_hidden").val("");//课程
                //    jQuery("#div_Duration_hidden").val("");//上课时长
                //    jQuery("#div_Mode_hidden").val("");//上课方式
                //    jQuery("#div_Subject_hidden").val("");//科目分类
                //    jQuery("#div_Age_hidden").val("");//年龄段


                //    jQuery("#div_Duration").removeAttr("hidden");
                //    jQuery("#div_Mode").removeAttr("hidden");
                //    jQuery("#div_Subject").removeAttr("hidden");
                //    jQuery("#div_Age").removeAttr("hidden");

                //    ReRenderMySelect("div_Org");//机构下拉框重置
                //    ReRenderMySelect("div_Course", "");//课程下拉框重置
                //    ReRenderMySelect("div_Duration");//上课时长下拉框重置
                //    ReRenderMySelect("div_Mode");//上课方式重置
                //    ReRenderMySelect("div_Mode");//上课方式重置
                //    ReRenderMySelect("div_Subject");//科目分类重置
                //    ReRenderMySelect("div_Age");//年龄段下拉框重置

                //    ////课程下拉框显示，自定义课程名称输入框隐藏
                //    //jQuery("#CourseName").val("").attr("hidden", "hidden");//自定义课程名称
                //    //jQuery("#div_Course").removeAttr("hidden");
                //    //jQuery("#CustomCourse").removeAttr("hidden");//自定义课程勾选显示
                //    //jQuery(".CustomCourse").removeAttr("hidden");//自定义课程文本显示
                //    ////隐藏已有课程（四个input）
                //    //jQuery("#Duration").val("").attr("hidden", "hidden");
                //    //jQuery("#Mode").val("").attr("hidden", "hidden");
                //    //jQuery("#Subject").val("").attr("hidden", "hidden");
                //    //jQuery("#Age").val("").attr("hidden", "hidden");


                //    ////展示变为请选择
                //    //jQuery("#div_Org div[class=select-picker-search-checked]").text("请选择");     //机构
                //    //jQuery("#div_Course div[class=select-picker-search-checked]").text("请选择");  //课程
                //    //jQuery("#div_Duration div[class=select-picker-search-checked]").text("请选择");//上课时长
                //    //jQuery("#div_Mode div[class=select-picker-search-checked]").text("请选择");    //上课方式
                //    //jQuery("#div_Subject div[class=select-picker-search-checked]").text("请选择"); //科目分类
                //    //jQuery("#div_Age div[class=select-picker-search-checked]").text("请选择");     //年龄段

                //    ////清空隐藏选中项value
                //    //jQuery("#div_Org_hidden").val("");//机构
                //    //jQuery("#div_Course_hidden").val("");//课程
                //    //jQuery("#div_Duration_hidden").val("");//上课时长
                //    //jQuery("#div_Mode_hidden").val("");//上课方式
                //    //jQuery("#div_Subject_hidden").val("");//科目分类
                //    //jQuery("#div_Age_hidden").val("");//年龄段



                //});
                ////自定义课程
                //jQuery("#CustomCourse").on("click", function () {
                //    if (jQuery(this).attr("checked")) {
                //        //只是为了去掉勾选样式,不需做业务处理
                //    } else {
                //        //展示自定义课程相关项
                //        //课程名称
                //        jQuery("#CourseName").val("").removeAttr("hidden");//自定义课程名称
                //        jQuery("#CustomCourse").attr("checked", "checked").removeAttr("hidden");
                //        jQuery(".CustomCourse").removeAttr("hidden");//自定义课程勾选框
                //        //上课时长
                //        jQuery("#div_Duration").removeAttr("hidden");
                //        jQuery("#div_Duration_hidden").val("");

                //        //上课方式
                //        //jQuery("#div_Mode").removeAttr("hidden");
                //        //jQuery("#div_Mode_hidden").val("");
                //        ReRenderMySelect("div_Mode");//上课方式重置
                //        ReRenderMySelect("div_Mode");//上课方式重置

                //        //科目分类
                //        jQuery("#div_Subject").removeAttr("hidden");
                //        jQuery("#div_Subject_hidden").val("");
                //        //年龄段
                //        jQuery("#div_Age").removeAttr("hidden");
                //        jQuery("#div_Age_hidden").val("");

                //        jQuery("#div_Course").attr("hidden", "hidden");//课程下拉框隐藏，显示自定义课程名称输入框
                //        jQuery("#div_Course_hidden").val("");
                //        //隐藏已有课程（四个input）
                //        jQuery("#Duration").val("").attr("hidden", "hidden");
                //        jQuery("#Mode").val("").attr("hidden", "hidden");
                //        jQuery("#Subject").val("").attr("hidden", "hidden");
                //        jQuery("#Age").val("").attr("hidden", "hidden");
                //    }


                //});
                //机构-课程联动
                jQuery(document).on('click touch', '#div_Org .select-picker-options-list-item', function (e) {
                    e.preventDefault();
                    //var orgid = jQuery(this).attr("id");
                    var orgids = jQuery("#div_Org_hidden").val();
                    SetCourseData(orgids, jQuery("#div_Course_select"));

                })
                function SetCourseData(orgId, $select) {
                    debugger;
                    if (orgId == null || orgId == 0) {
                        return;
                    }
                    if (orgId.indexOf(',') > 0) {//多选则不联动
                        $select.empty();
                        jQuery("#div_Course").mySelect();//课程div_Course
                        ReRenderMySelect("div_Course");
                    } else {
                        jQuery.getJSON("@Url.Action("ChangeCourseData", "EvaluationCrawler")", { orgId: orgId }, function (data) {

                            var options = "";
                            jQuery.each(data, function (index, item) {
                                options += '<option value="' + item.value + '">' + item.text + '</option>';
                            });

                            jQuery("#div_Course .select-picker-search").each(function (index) {
                                jQuery(this).remove();
                            })
                            jQuery("#div_Course .select-picker-options-wrp").each(function (index) {
                                jQuery(this).remove();
                            })
                            $select.empty();
                            $select.append(options);
                            jQuery("#div_Course").mySelect();//课程div_Course
                            ReRenderMySelect("div_Course");
                        });
                    }
                }

                //选择已有课程
                @*jQuery(document).on('click touch', '#div_Course .select-picker-options-list-item', function (e) {
                    e.preventDefault();
                    var courseId = jQuery(this).attr("id");
                    jQuery.getJSON("@Url.Action("ShowCourseById", "Courses")", { courseId: courseId }, function (d) {
                        //展示已有课程信息，隐藏自定义课程选项

                        //展示已有课程信息，隐藏自定义课程选项

                        //隐藏自定义相关
                        //课程名称
                        jQuery("#CourseName").val("").attr("hidden", "hidden")
                        jQuery("#CustomCourse").attr("hidden", "hidden").removeAttr("checked");
                        jQuery(".CustomCourse").attr("hidden", "hidden");//自定义课程勾选框
                        //上课时长
                        jQuery("#div_Duration").attr("hidden", "hidden");
                        jQuery("#div_Duration_hidden").val("");
                        //上课方式
                        jQuery("#div_Mode").attr("hidden", "hidden");
                        jQuery("#div_Mode_hidden").val("");
                        //科目分类
                        jQuery("#div_Subject").attr("hidden", "hidden");
                        jQuery("#div_Subject_hidden").val("");
                        //年龄段
                        jQuery("#div_Age").attr("hidden", "hidden");
                        jQuery("#div_Age_hidden").val("");

                        //展示已有课程（四个input）
                        jQuery("#Duration").val(d.duration).removeAttr("hidden")
                        jQuery("#Mode").val(d.modes).removeAttr("hidden")
                        jQuery("#Subject").val(d.subject).removeAttr("hidden")
                        jQuery("#Age").val(d.ageRange).removeAttr("hidden")



                        //

                        //var data = d.data;

                        ////隐藏自定义课程名称，并且不可勾选
                        //jQuery("#CustomCourse").attr("hidden", "hidden").removeAttr("checked");
                        //jQuery(".CustomCourse").attr("hidden", "hidden");

                        ////上课时长
                        //jQuery("#Duration").val((data.duration == null || data.duration <= 0) ? "未收录" : data.duration + " 分钟").removeAttr("hidden");
                        //jQuery("#div_Duration").attr("hidden", "hidden");

                        ////上课方式--只读--选中项，并重新渲染
                        //jQuery("#div_Mode").attr("readonly", "readonly");
                        //var options_Modes = "";
                        //var Modes = JSON.parse(data.mode);
                        //console.log('Modes：' + Modes);
                        //jQuery("#div_Mode_select").find("option").each(function () {
                        //    var option = jQuery(this);
                        //    var checked = '';
                        //    if (Modes.indexOf(parseInt(option.val())) > -1) {
                        //        //则包含该元素
                        //        checked = 'data-id="duihao-checked" ';
                        //    }
                        //    options_Modes += '<option ' + checked + ' value="' + option.val() + '">' + option.text() + '</option>';
                        //});
                        //ReRenderMySelect("div_Mode", options_Modes)


                        ////科目分类--只读--选中项，并重新渲染
                        //jQuery("#div_Subject").attr("readonly", "readonly");
                        //var options_Subjects = "";
                        //jQuery("#div_Subject_select").find("option").each(function () {
                        //    var option = jQuery(this);
                        //    var checked = '';
                        //    if (option.val() == data.subject) {
                        //        checked = 'data-id="duihao-checked" ';
                        //    }
                        //    options_Subjects += '<option ' + checked + ' value="' + option.val() + '">' + option.text() + '</option>';
                        //});
                        //ReRenderMySelect("div_Subject", options_Subjects)

                        ////年龄段--只读，最大最小年龄Minage-Maxage
                        //var ageinput = (data.minage != null && data.maxage != null && data.maxage > 0) ? data.minage + '-' + data.maxage + '岁' : '未收录';
                        //jQuery("#Age").val(ageinput).removeAttr("hidden");
                        //jQuery("#div_Age").attr("hidden", "hidden");

                    });

                })*@

                //重新渲染下拉框
                function ReRenderMySelect(id, options) {

                    jQuery("#" + id + " .select-picker-search").each(function (index) {
                        jQuery(this).remove();
                    })
                    jQuery("#" + id + " .select-picker-options-wrp").each(function (index) {
                        jQuery(this).remove();
                    })

                    var iscanselect = false;//是否可选

                    //options包含选中项，则把选项传入,否则重置所有选项为未选中
                    if (options == null || options == undefined) {
                        options = "";
                        jQuery("#" + id + "_select").find("option").each(function () {
                            var option = jQuery(this);
                            options += '<option  value="' + option.val() + '">' + option.text() + '</option>';
                        });
                    }
                    jQuery("#" + id + "_select").empty();
                    jQuery("#" + id + "_select").append(options);
                    jQuery("#" + id).mySelect();//重新渲染

                }

            })();

            //是否加精
            jQuery("input[name=stick]").on("click", function () {
                jQuery(this).attr("checked", "checked");
            });
        });


        //保存抓取评测
            jQuery("#save").on("click", function () {

                console.log(GetFormData());
            var data = GetFormData();//获取表单数据
            if (!(data.Title.trim())) {
                ShowAlert("标题不能为空");
                return;
            }
            var IsUrgent = jQuery("input[type=radio][checked=checked]").val();
            data.IsUrgent = IsUrgent;
                showConfirm('确定保存评测？', function () {
                Loading("正在更新数据！");
                jQuery("#save").attr('disabled', 'disabled');
                jQuery.post("@Url.Action("SaveEditEvlt")", data, function (result) {

                    if (result.status ==200) {
                        ShowAlert("保存成功！", 1000, function () {
                            window.location.reload();
                        });
                    }
                    else {
                        ShowAlert(result.msg, -1);
                        CloseLoading();
                        jQuery("#save").removeAttr('disabled');
                    }
                });
            })
        });

        //获取表单数据
        function GetFormData() {
            var Id = '@Model.Id';
            var Title = jQuery(".card-body input[name='ETitle']").val();//标题
            var Specialid = jQuery("#div_Special_hidden").val();//专题id

            var listOrgId = [];
            var orgIds = jQuery("#div_Org_hidden").val();//机构id
            if (orgIds != null) {
                listOrgId = orgIds.split(',');
            }
            var video= jQuery(".vdo_vdo source").attr("src");
            var videoCover=jQuery(".vdo_vdo").attr("poster");


            var CourseId = null;//课程id
            CourseId = jQuery("#div_Course_hidden").val();
            var listCourseId = [];
            if (CourseId != null) {
                listCourseId = CourseId.split(',');
            }
            //var CourseName = "", Duration = null, Mode = null, Subject = null, Age = null;  //自定义课程信息
            //if (jQuery("#div_Course_hidden").val()) {//已有课程

            //    CourseId = jQuery("#div_Course_hidden").val();
            //}
            //else {//自定义课程
            //    //自定义课程
            //    CourseName = jQuery("#CourseName").val();//课程名称
            //    Duration = jQuery("#div_Duration_hidden").val() == "" ? null : jQuery("#div_Duration_hidden").val();//上课时长枚举
            //    var strmodes = jQuery("#div_Mode_hidden").val().split(',');
            //    var Modes = [];//上课方式枚举
            //    jQuery(strmodes).each(function (index, mode) {
            //        if (mode != "")
            //            Modes.push(parseInt(mode));
            //    });
            //    Mode = Modes.length == 0 ? null : JSON.stringify(Modes);
            //    Subject = jQuery("#div_Subject_hidden").val() == "" ? null : jQuery("#div_Subject_hidden").val();//科目分类枚举
            //    Age = jQuery("#div_Age_hidden").val() == "" ? null : jQuery("#div_Age_hidden").val();//年龄段枚举

            //}
            var IsStick = jQuery("#stick").attr("checked") ? true : false;//是否加精
            var Content = [], Url = [], ThumUrl = [], evltItemIds = [];//缩略图集合
            jQuery(".hidUrlJson").each(function (index, item) {
                Url.push(jQuery(item).val());
            });
            jQuery(".hidThunUrlJson").each(function (index, item) {
                ThumUrl.push(jQuery(item).val());
            });
            jQuery(".Content").each(function (index, item) {
                if (jQuery(item).val().trim().length == 0) {
                    ShowAlert("正文不允许为空！");
                    jQuery(item).focus();
                    return;
                }
                Content.push(jQuery(item).val());
            });
            jQuery(".hidevltItemIds").each(function (index, item) {
                evltItemIds.push(jQuery(item).val());
            });
            var listEvltItems = [];
            jQuery.each(evltItemIds, function (i, id) {
                if (i == 0) {
                    listEvltItems.push({ "Id": id, "Content": Content[i], "Pictures": Url[i], "Thumbnails": ThumUrl[i], "Video": video, "VideoCover": videoCover  });
                } else {
                    listEvltItems.push({ "Id": id, "Content": Content[i], "Pictures": Url[i], "Thumbnails": ThumUrl[i]});
                }
                
            });
            //进行判断
            var data =
            {
                "Id": Id,
                "Title": Title,
                "listEvltItems": listEvltItems, //JSON.stringify(listEvltItems),
                "Specialid": Specialid,
                "ListOrgId": listOrgId,
                "ListCourseId": listCourseId,
                //"OrgId": OrgId,
                //"CourseId": CourseId,
                //"CourseName": CourseName,
                //"Duration": Duration,
                //"Mode": Mode,
                //"Subject": Subject,
                //"Age": Age,
                "IsStick": IsStick
            };
            return data;
        }


        //=====================图片=====================
        //1、上传
        function UploadImg()
        {
            //上传logo--选择图片
            jQuery('.updateBtn').click(function () {
                var evltComType = jQuery(this).attr("id").split('-')[jQuery(this).attr("id").split('-').length - 1];//评测item-Type
                //最多上传10张
                var Url = JSON.parse(jQuery("#hidUrlJson-" + evltComType).val()||[]);//图片集合

                if (evltComType > 0) {//专业模式
                    var imgCount = 0;
                    imgCount += JSON.parse(jQuery("#hidUrlJson-1").val()).length;
                    imgCount += JSON.parse(jQuery("#hidUrlJson-2").val()).length;
                    imgCount += JSON.parse(jQuery("#hidUrlJson-3").val()).length;
                    if (imgCount>= 10) {
                        ShowAlert('最多上传10张图片');
                        return;
                    }

                }
                else {//自由模式
                    if (Url.length >= 10) {
                        ShowAlert('最多上传10张图片');
                        return;
                    }
                }

                var $inputfileid = jQuery(this).attr('data-video') + "-" + evltComType;
                return jQuery('#' + $inputfileid).click(); //注意这句，主要是需要return点击事件返回值,模拟触发type=file控件
            });
            //上传logo--自动上传
            jQuery('.updateFile').on("change", function () {

                var fileinput = jQuery(this);//上传文件
                var videoInput = fileinput.attr('id');
                var $videoInput = document.getElementById(videoInput);
                if ($videoInput.files.length == 0) {
                    return;
                }
                var formData = new FormData();
                for (var i = 0; i < $videoInput.files.length; i++) {
                    formData.append(videoInput, $videoInput.files[i]);
                }

                var evltComType = videoInput.substr(videoInput.length - 1, 1);//评测内容Type

                Loading("正在上传图片！");
                 jQuery.ajax({
                    url: "@ViewBag.OrgeEvltCrawlerUploadUrl",
                    type: "post",
                    data: formData,
                    processData: false,
                    contentType: false,
                    cache: false
                }).done(function (res) {

                    if (res.status == 200) {
                        ShowAlert('上传成功', 1000, function () {
                            fileinput.val('');

                            var url = res.data.src;
                            var url_s = res.data.src_s;
                            AddUrl(url, url_s, evltComType)
                            ReloadImg(evltComType);

                        });

                    } else {
                        ShowAlert("上传失败:"+res.msg, -1);
                        CloseLoading();
                    }
                    CloseLoading();
                }).fail(function (res) {
                    ShowAlert("网络异常:"+res.msg, -1);
                    CloseLoading();
                });
            })
        }

        //2、删除图片body  piclist
        jQuery("body").delegate(".deletebutten", "click", function () {


            var $input = jQuery(this);
            var id = $input.attr("id");
            var evltComType = id.substr(id.length - 1, 1);//评测内容Type
            var delUrl = $input.attr("data-input");//url
            var json = JSON.parse(jQuery("#hidUrlJson-" + evltComType).val());
            var jsonResult = [];

            jQuery.each(json, function (index, url) {
                console.log('url:', url, 'delUrl:', delUrl, '==:', url != delUrl)
                if (url != delUrl) {
                    jsonResult.push(url);
                }
                else {

                    var thundata = JSON.parse(jQuery("#hidThunUrlJson-" + evltComType).val());
                    thundata.splice(index, 1);
                    jQuery("#hidThunUrlJson-" + evltComType).val(JSON.stringify(thundata));
                }
            });
            jQuery("#hidUrlJson-" + evltComType).val(JSON.stringify(jsonResult));
            console.log('html:', jQuery("#hidUrlJson-" + evltComType).val(JSON.stringify(jsonResult)), JSON.stringify(jsonResult))
            GetImgHtml(jsonResult, evltComType);
        });

        //3、下载
        function downloadIamge() {//下载图片地址和图片名
            jQuery(".downloadpic").on("click", function () {
                var $aimg = jQuery(this);
                var url = $aimg.attr('data-input');
                var fileName = url.split(/(\\|\/)/g).pop();

                forceDownload(url, fileName);

            });

        }
        function forceDownload(url, fileName) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "blob";
            xhr.onload = function () {
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(this.response);
                var tag = document.createElement('a');
                tag.href = imageUrl;
                tag.download = fileName;
                document.body.appendChild(tag);
                tag.click();
                document.body.removeChild(tag);
            }
            xhr.send();
        }

        //重新渲染图片
            function ReloadImg(evltComType) {
                var data = JSON.parse(jQuery("#hidUrlJson-" + evltComType).val());
                GetImgHtml(data, evltComType);
            }
        function GetImgHtml(data, evltComType) {

                var html = '<div class="row img-margin-left">';
                jQuery(data).each(function (index, url) {

                    //img
                    html += ' <div class="col-md-2">'
                        + '     <div class="form-inline">'
                        + '        <a id="deletebutten-' + evltComType + '" class="delrankbtn fa fa-minus-circle deletebutten  text-danger" data-input="' + url + '"></a>'
                        + '        <img style="width:100px;height:100px;" src="' + url + '">'
                        + '       </div>'
                        + '       <div class="form-inline">'
                        + '           <div id="' + url + '" class="col-md-7" style="text-align:center;">'
                        + '               <a href="javascript:void(0)" data-id="" class="downloadpic text-info"   data-input="' + url + '" >下载</a>  '
                        + '           </div>'
                        + '           <div class="col-md-5"></div>'
                        + '      </div>'
                        + '    </div>'
                    //next row  i+1
                    if ((index + 1) % 4 == 0) {
                        html += '</div><div class="row img-margin-left">';
                    }

                });
                //i=data.length-1,上传按钮
                html += '    <div class="col-md-2">'
                    + '        <input type="file" id="@(Model.Id)-' + evltComType + '" hidden="hidden" class="c_ignore updateFile" name="files" multiple="" accept="jpg,png" title="只允许上传Mp4格式的视频!视频大小不能超过40M">'
                    + '            <input type="button" id="uploadlogo-' + evltComType+'" style="width: 100px; height: 100px; font-size: 50px;" class="uploadvideo-btn btn  btn-info btn-block c_ignore updateBtn" data-video="@Model.Id" data-input="InterviewVideos" value="+">'
                    + '</div>';
                html += '</div>';
            jQuery("#img-list-" + evltComType).html(html);

                UploadImg();
                downloadIamge();
            }

        //原图、缩略图集合增加图片地址
            function AddUrl(url, thunurl, evltComType) {

                var Url = JSON.parse(jQuery("#hidUrlJson-" + evltComType).val());//图片集合
                var ThumUrl = JSON.parse(jQuery("#hidThunUrlJson-" + evltComType).val());//缩略图集合

                Url.push(url);
                ThumUrl.push(thunurl);
                jQuery("#hidUrlJson-" + evltComType).val(JSON.stringify(Url));
                jQuery("#hidThunUrlJson-" + evltComType).val(JSON.stringify(ThumUrl));
            }

        //上传video
        jQuery('.uploasingledvideo').on('click', function () {
            debugger;
            var k = jQuery(this).attr('data-video');
            var fileUpload = jQuery('[name=' + k + ']').get(0);
                var files = fileUpload.files;
                if (files.length <= 0) {
                    return false;
				}
                Loading('视频上传中...');
                var data = new FormData();
                for (var i = 0; i < files.length; i++) {
                    data.append(k, files[i]);
            }
            jQuery.ajax({
                    type: "POST",
                    url: "/school/upload?type=3&id=@Model.Id",
                    contentType: false,
                    processData: false,
                    cache: false,
                    data: data
            }).done(function (res) {
                    CloseLoading();
                if (res.state == 200) {
                    debugger;
                        fileUpload.value = '';
                        var coverurl = res.result[0].message;
                        var mp4 = res.result[0].value;
                        showvideo(mp4, coverurl);

                        jQuery("#videshow").removeAttr("hidden");
                        CloseLoading();
                    } else {
                        ShowAlert(res.message);
                    }
                }).fail(function (res) {
                     CloseLoading();
                    ShowAlert(res.message);
                });
        });
        //删除视频
        function delvideo() {
            jQuery("#delvideo").on('click', function () {
                debugger;
                jQuery(".vdo_vdo source").attr("src", '');
                jQuery(".vdo_vdo").attr("poster", '');
                jQuery("#videshow").html('');
            });
        } delvideo();


        function showvideo(video,videocover)
        {
            debugger;

            var html = "";
            html += '<div id="" class="col-md-4">';
            html += '            <div class="row ppvideo">';
            html += '                <div class="col-md-4">';
            html += '                    <video class="vdo_vdo" style="object-fit:cover;" width="250" height="150" controls="" data-id="a492dd5d-75ea-4ed8-8860-2d75a6755b71" poster="' + videocover+'">';
            html += '                        <source src="' + video+'" type="video/mp4">';
            html += '                    </video>';
            html += '                </div>';

            html += '                <div class="col-md-6"><a id="delvideo" class="fa fa-minus-circle delvideo text-danger"></a></div>';
            html += '            </div>';
            html += '<a href="javascript:void(0)" id="downlvideo" data-id="" class="downloadpic text-info" data-input="' + video+'">下载</a>';
            html += '         </div>';
            jQuery("#videshow").html(html);
            downloadIamge();
            delvideo();
        }
    </script>
}
